---
title: Basic modification of diagrams 
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Basic modification of diagrams}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7
)

# avoid check where vignette filename must equal the vignette title
options(rmarkdown.html_vignette.check_title = FALSE)
```

```{r setup, include = FALSE}
pkg = 'flowdiagramr' #so we can easily switch names
library(pkg, character.only = TRUE)
```

## Introduction

We assume you went through the [getting started vignette](./A_quickstart.html) and know the basics of using **`r pkg`**. 
In this vignette, you will learn the simplest ways of customizing diagrams. Further vignettes show more advanced approaches.


## Setting arguments in `make_diagram`

The last example of the [getting started vignette](./A_quickstart.html) showed an example on how to customize the diagram by setting verious options when calling the `make_diagram` function. The help file for the function shows you all the settings you can customize, you can look at it with this command

```{r, eval = FALSE}
help('make_diagram')
```

We are not showing all the options here (you'll see them when you call the help file), but let's explore some of those options and what they do. 

To illustrate this approach, we'll play with an extension of the SIR model. For this extension, we also include natural births and deaths. We assume new births only enter the **S** compartment at some fixed flow, **n**, while deaths occur at rate **m** out of all compartments. The model is specified as follows

```{r}
# specify the model
varlabels = c("S","I","R")
flows = list(S_flows = c("n", "-b*S*I", "-m*S"), 
             I_flows = c("+b*S*I","-g*I", "-m*I"), 
             R_flows = c("g*I", "-m*R"))
sirmodel = list(varlabels = varlabels, flows = flows)
```


First, we need to call `prepare_diagram` to make the list of data frames needed as input for `make_model`. We'll skip over this step again for now, you'll learn more about these data frames and how to potentially modify them, in a later vignette.


```{r}
# prepare inputs 
sir_diagram_list <- prepare_diagram(sirmodel)
```

Now, let's produce a basic diagram by calling `make_diagram` with its defaults.


```{r}
# make a default diagram
default_diagram <- make_diagram(sir_diagram_list)
plot(default_diagram)
```

This looks ok, but maybe you want to make some adjustments. You can adjust several parts of the diagram fairly easily using the input options to the `make_diagram` function to change the look.


**IN ALL EXAMPLES SHOWN, ONLY LIST THOSE INPUTS THAT ARE DIFFERENT THAN DEFAULT**

```{r}
#define settings that change the look of the diagram
sir_diagram_settings <- list(
    node_outline_color = "black",
    node_fill_color = c("#6aa4c8", "#eb5600", "#1a9988"),
    node_text_color = "black",
    node_text_size = 14,
    flow_text_color = "black",
    flow_text_size = 8,
    main_arrow_color = "blue",
    main_arrow_linetype = "solid",
    main_arrow_size = 1,
    interaction_arrow_color = "red",
    interaction_arrow_linetype = "dashed",
    interaction_arrow_size = 0.7)

# make a diagram with adjusted settings
new_diagram <- make_diagram(
  diagram_list = sir_diagram_list,
  diagram_settings = sir_diagram_settings 
  )
plot(new_diagram)
```

As you can see, it is possible to change the look of the diagram considerably by simply providing custom values to the `make_diagram` input options.

Let's look at a few more options that you can configure. By default, **`r pkg`** shows all flows and labels them all. 
While it is generally a good idea to show as much information as possible in your diagram, sometimes having too much detail leads to a messy and hard-to-read diagram. In such cases, not showing certain parts of the model might make sense. 

You can easily turn on and off several components. The following code shows an example where we turned off labeling of the flows. We also turned off plotting of the flows that come into or go out of the system from the outside. In this example, those are births and deaths.

Note that if you turn off certain components, any settings that apply styling to those settings will be ignored. You can see that in this example, where we kept some settings for the styling, but since flow labels and external flows are not plotted, any styling applied to them is ignored.


```{r}
#define settings that remove plotting of all flow labels and inflows/outflows
simpler_diagram_settings <- list(
    node_outline_color = "black",
    node_fill_color = c("#6aa4c8", "#eb5600", "#1a9988"),
    node_text_color = "black",
    node_text_size = 14,
    label_flows = FALSE,
    external_flows = FALSE,
    flow_text_color = "black",
    flow_text_size = 8,
    main_arrow_color = "blue",
    main_arrow_linetype = "solid",
    main_arrow_size = 1,
    interaction_arrow_color = "red",
    interaction_arrow_linetype = "dashed",
    interaction_arrow_size = 0.7)

# make a diagram with adjusted settings
simpler_diagram <- make_diagram(
  diagram_list = sir_diagram_list,
  diagram_settings = simpler_diagram_settings 
  )
plot(simpler_diagram)
```




## Providing additional input when specifying the model

There is another simple, but likely often quite useful way you can make adjustments to the model plot.
You previously learned that to specify a model, you need to set up a list that contains at minimum the elements `varlabels` and `flows`. That's what we used so far. It is possible to supply a few additional elements, namely the element `varnames` which contains the full names for each variable/compartment and an element `varlocations`, which contains a matrix showing the grid-based arrangement of the compartment boxes. Let's see it in action.


### Example 1

Let's look at the SIR model again we just explored. We now specify it with the additional two arguments just introduced.

```{r}
varlabels = c("S","I","R")
flows = list(S_flows = c("n", "-b*S*I", "-m*S"), 
             I_flows = c("+b*S*I","-g*I", "-m*I"), 
             R_flows = c("g*I", "-m*R"))
varnames = c("Susceptible","Infected","Recovered")
varlocations = matrix(data = c("S", "", "R",
                               "", "I", "" ),nrow = 2, ncol = 3, byrow = TRUE)
sirmodel = list(varlabels = varlabels, flows = flows, varnames = varnames, varlocations = varlocations)
```

The `varnames` argument is self-explanatory. If you supply this argument, you can have the variable names be shown in the plot by setting `use_varnames = TRUE` when calling the `make_diagram` function.

The `varlocations` argument needs some explanation. What this allows you to do is to define a grid and place the compartments at specific locations. This is often necessary when you create more complicated models since the automated placement of the variables/nodes by `make_diagram` is likely not ideal. For this simple model, having all compartments along a single row is ok. But to illustrate the use of `varlocations`,  we defined a grid with 2 rows and 3 columns and placed the **S** and **R** compartments in the left and right corner of the top row and the **I** compartment in the middle of the bottom row. All other slots are empty. 
You can take this extended specification of the model and feed it to the diagram preparation and generation functions, like so.

```{r}
# prepare inputs 
sir_diagram_list <- prepare_diagram(sirmodel)
# specify a few settings to show variable names 
diagram_settings = list(node_text_size = 4,
                            use_varnames = TRUE)
# make  diagram
sir_diagram <- make_diagram(diagram_list = sir_diagram_list,
                            diagram_settings = diagram_settings)
plot(sir_diagram)
```

Note that we also provided the `make_diagram` function with an option that specified that we wanted to use the variable names to label the boxes instead of the labels/abbreviations. 

### Example 2

Let's do another example, one that might come up somewhat often, where you need a figure that is mostly vertical. We can do this for the SIR model by adjusting the `varlocations` matrix and replacing the new structure in the model specification

```{r}
varlocations = matrix(data = c("S", "I", "R"), nrow = 3,  byrow = TRUE)
sirmodel$varlocations <- varlocations
```

With this setup, the diagram looks like this

**DIAGRAM NOT LOOKING GOOD**

```{r, fig.height=5}
sir_diagram_list <- prepare_diagram(sirmodel)
sir_diagram <- make_diagram(sir_diagram_list)
plot(sir_diagram)
```


## Combining the two approaches

It is of course possible to adjust the look of the diagram by combining the two approaches we just described.

Let's look at this for the somewhat large model with 7 compartments shown in the _Getting Started_ vignette. 

Here is the model again, this time with locations specified. We place the 2 *SIR* compartments on the top and the bottom, and the **P** compartment in the middle.

```{r}
varlabels = c("Sc","Ic","Rc","Sa","Ia","Ra","P")
varnames = c("Susceptible Children","Infected Children","Recovered Children","Susceptible adults","Infected adults","Recovered adults","Pathogen in Environment")
flows = list(Sc_flows = c("-Sc*bcc*Ic","-Sc*bca*Ia","-Sc*bcp*P"), 
             Ic_flows = c("Sc*bcc*Ic","Sc*bca*Ia","Sc*bcp*P","-gc*Ic"), 
             Rc_flows = c("gc*Ic"),
             Sa_flows = c("-Sa*bac*Ic","-Sa*baa*Ia","-Sa*bap*P"), 
             Ia_flows = c("Sa*bac*Ic","Sa*baa*Ia","Sa*bap*P","-ga*Ia"), 
             Ra_flows = c("ga*Ia"),
             P_flows = c("sc*Ic","sa*Ia","-d*P")
             )
varlocations = matrix(data = c("Sc", "Ic", "Rc",
                               "",   "P",   "",
                               "Sa", "Ia", "Ra"),nrow = 3, byrow = TRUE)
mymodel = list(varlabels = varlabels, flows = flows, varlocations = varlocations, varnames = varnames)
diagram_list <- prepare_diagram(mymodel)
```

In a next step, we apply different styling to the diagram

```{r}
diagram_settings <- list(
       node_fill_color = c("#6aa4c8", "#eb5600", "#1a9988", "#2987c2", "#e38b59", "#5c948c", "#e8e656"),
                          node_text_size = 4,
                          use_varnames = TRUE
                        )
model_plot <- make_diagram(diagram_list, diagram_settings)
plot(model_plot)
```

**SOME ARROWS SEEM TO START/END IN MIDDLE OF BOXES INSTEAD OF EDGES**

**IF USER SETS use_Varnames = TRUE BUT THERE ARE NONE, SHOULD PRINT A WARNING MESSAGE**

This starts to look better, though the placement of the labels is clearly not ideal and needs some more tweaking.



## Next steps

With the approach just discussed, you can tweak the look of the diagram a good bit. This might give you a diagram that's good enough for what you want. However, at times you might want to make further changes. For instance you might want to tweak the placement of the boxes and arrows or add some extra text somewhere on the diagram. **`r pkg`** gives you ways of doing this. 

After you have exhausted the modifications described here, and need to make further changes, we recommend as a next step to tweak the input structure that is produced by the `prepare_diagram` function before sending it to the `make_diagram` function. This gives you a good bit more flexibility in adjusting the model, and is not that difficulty to do. This is described [in the next vignette](./C_modify_input_structure.html).    

Finally, it is possible to obtain the underlying code that produces the plot and manually adjust anything you like. This is most flexible, but also requires the most manual intervention. We get to that after you have gone through the [next vignette](./C_modify_input_structure.html).







